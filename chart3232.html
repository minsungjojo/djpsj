<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>거래소별 BTC 보유량 - 스택형 막대 차트</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
    <label for="startDate">시작 날짜: </label>
    <input type="date" id="startDate">
    <label for="endDate">종료 날짜: </label>
    <input type="date" id="endDate">
    <button onclick="loadChart()">차트 업데이트</button>
    <div id="chart"></div>

    <script>
        let chart;

        function loadChart() {
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;

            fetch('b3232.json') // JSON 파일 경로를 설정하세요.
                .then(response => response.json())
                .then(data => {
                    // 선택된 날짜 범위 내의 데이터만 필터링
                    const filteredData = data.filter(item => {
                        const date = new Date(item.day);
                        return (!startDate || date >= new Date(startDate)) &&
                               (!endDate || date <= new Date(endDate));
                    });

                    // 날짜별로 정렬된 카테고리 생성
                    const categories = [...new Set(filteredData.map(item => item.day))].sort((a, b) => new Date(a) - new Date(b));

                    // 거래소 목록 생성
                    const exchanges = [...new Set(filteredData.map(item => item.exchange))];

                    // 거래소별로 데이터 그룹화
                    const series = exchanges.map(exchange => {
                        return {
                            name: exchange,
                            data: categories.map(day => {
                                const entry = filteredData.find(item => item.day === day && item.exchange === exchange);
                                return entry ? entry.value : 0;
                            })
                        };
                    });

                    // 차트가 이미 렌더링되어 있으면 삭제
                    if (chart) {
                        chart.destroy();
                    }

                    // ApexCharts 설정
                    const options = {
                        chart: {
                            type: 'bar',
                            height: 700,
                            stacked: true
                        },
                        series: series,
                        xaxis: {
                            categories: categories,
                            title: {
                                text: '날짜'
                            },
                            labels: {
                                rotate: -45,
                                style: {
                                    fontSize: '12px'
                                },
                                hideOverlappingLabels: true,
                                showDuplicates: false,
                                formatter: function (val) {
                                    const date = new Date(val);
                                    return date.toISOString().slice(0, 10);
                                },
                            },
                            tickAmount: Math.min(10, categories.length),
                        },
                        yaxis: {
                            title: {
                                text: 'BTC 보유량'
                            }
                        },
                        colors: ['#FFD700', '#87CEEB', '#FF69B4', '#32CD32', '#FFA07A', '#BA55D3', '#20B2AA', '#F08080', '#FF4500', '#6A5ACD'],
                        tooltip: {
                            enabled: true,
                            shared: true,
                            followCursor: true,
                            intersect: false,
                            y: {
                                formatter: function (val) {
                                    return val.toFixed(2);
                                }
                            }
                        },
                        fill: {
                            opacity: 1
                        },
                        legend: {
                            position: 'right',
                            offsetY: 40,
                            floating: false,
                        },
                        dataLabels: {
                            enabled: false
                        }
                    };

                    // 차트 생성 및 렌더링
                    chart = new ApexCharts(document.querySelector("#chart"), options);
                    chart.render();
                })
                .catch(error => console.error('데이터를 가져오는 중 오류가 발생했습니다:', error));
        }
    </script>
</body>
</html>
